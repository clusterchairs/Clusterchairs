<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClusterChairs</title>
    <link rel="stylesheet" href="index.js">
    <link rel="stylesheet" href="index.html">
    <link rel="stylesheet" href="office.css">
    <link href="https://fonts.googleapis.com/css2?family=Protest+Strike&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f1f2f4;
        }

        .cart-container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 32px 24px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 18px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
        }

        .cart-item .details {
            flex: 1;
        }

        .cart-item .name {
            font-weight: bold;
        }

        .cart-item .remove-btn {
            background: #e53935;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .pay-btn {
            background: #4CAF50;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            width: 100%;
        }

        .whatsapp-float {
            position: fixed;
            left: 24px;
            bottom: 360px;
            z-index: 1001;
            display: flex;
            align-items: center;
        }

        .whatsapp-main-icon {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            background: #25d366;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .whatsapp-float:hover .whatsapp-main-icon {
            transform: scale(1.1);
        }

        .whatsapp-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.18);
            padding: 16px 20px;
            margin-left: 16px;
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
            transition: opacity 0.3s, transform 0.3s;
            min-width: 180px;
        }

        .whatsapp-float:hover .whatsapp-container {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }

        .whatsapp-link .whatsapp-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s;
        }

        .whatsapp-link {
            color: #25d366;
            font-weight: bold;
            text-decoration: none;
            font-size: 16px;
            transition: color 0.2s;
        }

        .whatsapp-link:hover {
            color: #128c7e;
        }

        .whatsapp-link .whatsapp-icon:hover {
            transform: scale(1.1);
        }

        /* Corrected CSS for the floating text bar */
        #floating-text-bar {
            position: fixed;
            /* Use fixed positioning to keep it in the viewport */
            top: 110px;
            /* Position it below the navbar, adjust as needed */
            width: 100%;
            /* Make it span the full width of the screen */
            background-color: #794141;
            color: yellow;
            padding: 12px 0;
            /* Adjust padding for spacing */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            overflow: hidden;
            /* Hide the content that scrolls out of view */
            text-align: center;
            white-space: nowrap;
            /* Keep the text on a single line */
            font-size: 16px;
        }

        /* Style for the text inside the bar */
        #floating-text-bar p {
            margin: 0;
            display: inline-block;
            /* Make the paragraph an inline block to apply animation */
            animation: scrollText 30s linear infinite;
            /* Animation for right-to-left movement */
            padding-left: 100%;
            /* Start the text off-screen to the right */
        }

        /* Keyframe animation for the continuous right-to-left scroll */
        @keyframes scrollText {
            from {
                transform: translateX(0);
                /* Start at the padded position */
            }

            to {
                transform: translateX(-200%);
                /* Move 200% of its width to the left */
            }
        }
    </style>
</head>

<body>

    <script src="auth.js"></script>
    <header class="navbar">
        <a href="index.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
            <div class="logo"><img src="image/logo.png" alt="Logo"></div>
            <div class="location">Cluster<br><span>Chairs</span></div>
        </a>
        <div class="nav-links">
            <a href="login.html" id="account-link" style="font-size: 20px;">Account & Lists</a>
            <a href="#" id="logout-link" style="font-size: 20px; display: none;">Logout</a>
            <a href="cart.html">
                <img src="image/cartimage.png" class="cart"
                    style="height: 40px; margin-top: -10px; vertical-align: middle;">
                <span id="cart-count"
                    style="color: #fff; border-radius: 50%; padding: 2px 2px 2px 2px; margin-left: 4px; font-size: 20px;">0</span>
            </a>
        </div>

    </header>
    <div id="floating-text-bar">
        <p>Contact us for negotiations to get better prices if buying in bulk. ðŸ“ž</p>
    </div>

    <div class="cart-container">
        <h2>Your Cart</h2>
        <div id="cart-items"></div>
        <div id="cart-total" style="margin-top:20px; font-size:1.2em; font-weight:bold;"></div>
        <div class="address-container"
            style="margin-top: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
            <h3>Shipping Address</h3>
            <form id="address-form">
                <input type="text" id="street" placeholder="Street Address"
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    required>
                <input type="text" id="city" placeholder="City"
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    required>
                <input type="text" id="state" placeholder="State"
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    required>
                <input type="text" id="zip" placeholder="Zip Code"
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    required>
            </form>
        </div>
        <button class="pay-btn" onclick="payNow()">
            Pay Now
        </button>
    </div>

    <div class="whatsapp-float">
        <img src="image/WhatsApp.jpg" alt="WhatsApp" class="whatsapp-main-icon">
        <div class="whatsapp-container">
            <a href="https://wa.me/918149231317" target="_blank" class="whatsapp-link">Swayam Divekar</a>
            <a href="https://wa.me/919969566885" target="_blank" class="whatsapp-link">Amol Kismisnath Mhaske</a>
            <!-- <a href="https://wa.me/919833217304" target="_blank" class="whatsapp-link">Omkar Lad</a> -->
        </div>
    </div>


    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


    <script>
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItemsDiv = document.getElementById('cart-items');
            const cartTotalDiv = document.getElementById('cart-total');
            const payButton = document.querySelector('.pay-btn');

            document.getElementById('cart-count').textContent = cart.length;

            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p>Your cart is empty.</p>';
                cartTotalDiv.textContent = '';
                payButton.style.display = 'none';
                return;
            }

            payButton.style.display = 'block';
            cartItemsDiv.innerHTML = '';

            const groupedItems = {};
            cart.forEach(item => {
                const key = `${item.name}-${item.price}`;
                if (groupedItems[key]) {
                    groupedItems[key].quantity += 1;
                } else {
                    groupedItems[key] = {
                        ...item,
                        quantity: 1
                    };
                }
            });

            let total = 0;
            Object.values(groupedItems).forEach((item) => {
                total += Number(item.price) * item.quantity;
                cartItemsDiv.innerHTML += `
 <div class="cart-item">
 <img src="${item.img}" alt="${item.name}">
 <div class="details">
 <div class="name">${item.name}</div>
 <div>â‚¹${item.price} x ${item.quantity} = â‚¹${(item.price * item.quantity).toFixed(2)}</div>
 </div>
<button class="remove-btn" onclick="removeFromCart('${item.name}','${item.price}')">
 Remove
 </button>
 </div>
 `;
            });
            cartTotalDiv.textContent = `Total: â‚¹${total.toFixed(2)}`;
        }

        function removeFromCart(name, price) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const idx = cart.findIndex(item => item.name === name && item.price === price);

            if (idx > -1) {
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }
        }

        window.addEventListener('load', renderCart);

        async function payNow() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
    }

    // Get address details from the form
    const street = document.getElementById('street').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zip = document.getElementById('zip').value;

    // Check if any address field is empty
    if (!street || !city || !state || !zip) {
        alert("Please fill in your complete shipping address.");
        return;
    }

    const address = { street, city, state, zip };

    const groupedItems = {};
    cart.forEach(item => {
        const key = `${item.name}-${item.price}`;
        if (groupedItems[key]) {
            groupedItems[key].quantity += 1;
        } else {
            groupedItems[key] = {
                ...item,
                quantity: 1
            };
        }
    });

    const total = cart.reduce((sum, item) => sum + Number(item.price), 0);
    const token = localStorage.getItem('token');

    if (!token) {
        alert("You are not logged in. Please log in to proceed.");
        window.location.href = 'login.html';
        return;
    }

    try {
        const res = await fetch("http://localhost:5000/create-order", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: total,
                items: Object.values(groupedItems),
                // Include the address in the request body
                address: address
            })
        });

        const order = await res.json();

        if (res.status === 401 || res.status === 403) {
            alert("Your session has expired. Please log in again.");
            localStorage.removeItem('token');
            window.location.href = 'login.html';
            return;
        }

        if (!res.ok) {
            throw new Error(order.message || "Failed to create order on the server.");
        }

        const options = {
            key: "rzp_test_RJ8q6Yz0Jx8dCw",
            amount: order.amount,
            currency: order.currency,
            name: "ClusterChairs",
            description: "Order Payment",
            order_id: order.id,
            handler: async function (response) {
                const verifyRes = await fetch("http://localhost:5000/verify-payment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(response)
                });
                const verifyData = await verifyRes.json();
                if (verifyData.success) {
                    alert("Payment Successful!");
                    localStorage.removeItem('cart');
                    renderCart();
                } else {
                    alert("Payment Failed!");
                }
            },
            prefill: {
                name: "Enter your name",
                email: "Enter your email",
                contact: "Enter your phone number"
            },
            theme: {
                color: "#a05252"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();
    } catch (err) {
        console.error("Payment error:", err);
        alert(`Payment initialization failed: ${err.message}`);
    }
}
    </script>
</body>

</html>